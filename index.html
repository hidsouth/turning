<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Flow Field Short Lines</title>
    <style>
      body { margin: 0; overflow: hidden; background: black; }
      canvas { display: block; }
      #captureButton, #clearButton {
        position: absolute;
        bottom: 40px;
        border: none;
        border-radius: 50%;
        background: white;
        width: 70px;
        height: 70px;
        left: 50%;
        transform: translateX(-50%);
        cursor: pointer;
      }
      #clearButton {
        left: auto;
        right: 20px;
        bottom: 50px;
        width: 50px;
        height: 50px;
        background: red;
        border-radius: 10px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  </head>
  <body>
    <button id="captureButton"></button>
    <button id="clearButton"></button>
    <script>
      let video;
      let capturedImage;
      let particles = [];

      function setup() {
        createCanvas(windowWidth, windowHeight);

        // Back camera
        let constraints = {
          video: { facingMode: { ideal: "environment" } },
          audio: false
        };
        video = createCapture(constraints);
        video.size(width, height);
        video.hide();

        // Only 200 particles
        for (let i = 0; i < 200; i++) {
          particles.push(new Particle());
        }

        document.getElementById('captureButton').addEventListener('click', () => {
          capturedImage = video.get();
        });

        document.getElementById('clearButton').addEventListener('click', () => {
          clear();
          background(0);
        });

        background(0);
      }

      function draw() {
        if (capturedImage) {
          for (let p of particles) {
            p.update();
            p.show();
            p.reset();
          }
        } else {
          image(video, 0, 0, width, height);
        }
      }

      class Particle {
        constructor() {
          this.pos = createVector(random(width), random(height));
        }
        update() {
          let angle = noise(this.pos.x * 0.005, this.pos.y * 0.005) * TWO_PI;
          this.vel = p5.Vector.fromAngle(angle);
        }
        show() {
          if (capturedImage) {
            let px = constrain(floor(this.pos.x), 0, capturedImage.width - 1);
            let py = constrain(floor(this.pos.y), 0, capturedImage.height - 1);
            let c = capturedImage.get(px, py);
            stroke(c);
            strokeWeight(10); // thicker lines
            let angle = noise(this.pos.x * 0.01, this.pos.y * 0.01) * TWO_PI;
            let len = random(32, 48); // longer marks
            let x2 = this.pos.x + cos(angle) * len;
            let y2 = this.pos.y + sin(angle) * len;
            line(this.pos.x, this.pos.y, x2, y2);
          }
        }
        reset() {
          this.pos = createVector(random(width), random(height));
        }
      }
    </script>
  </body>
</html>
